<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M & J Wedding</title>
    <link rel="preconnect" href="https://script.google.com">
    <link rel="preconnect" href="https://script.googleusercontent.com">
    <link href="https://fonts.googleapis.com/css2?family=Pinyon+Script&family=Montserrat:wght@300;400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Great+Vibes&family=Montserrat:wght@300;400&family=Pinyon+Script&display=swap" rel="stylesheet">
<style>
    :root { 
        --paper: #fcfaf7; --gold: #bfa17a; --text: #4a4a4a; --accent: #043927; --pink: #f4cfe0; 
    }

    body, html { 
        margin: 0; padding: 0; background-color: #e5e0d8; 
        font-family: 'Montserrat', sans-serif; color: var(--text); 
        overflow: hidden; height: 100%; 
    }

/* --- THE LETTER SLIDE --- */
.letter {
    position: absolute;
    bottom: 5%; left: 5%;
    width: 90%; height: 90%;
    background: white;
    z-index: 2; 
    transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 20px;
    box-sizing: border-box;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
}

/* When the seal is clicked, the letter peeks out */
.open .letter {
    transform: translateY(-50%); /* Adjust this to show more/less of the letter */
}

    /* --- MUSIC PROMPT MODAL --- */
#music-prompt {
    position: fixed; /* Changed from absolute to fixed */
    top: 50%; 
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    z-index: 10000; /* Must be higher than envelope-wrapper (9999) */
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    border-radius: 15px;
    width: 300px;
    border: 2px solid var(--gold);
}
.prompt-btns {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
}

.prompt-btn {
    padding: 10px 20px;
    border: 1px solid var(--accent);
    background: none;
    cursor: pointer;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.8rem;
    transition: 0.3s;
}

.prompt-btn.yes { background: var(--accent); color: white; }
.prompt-btn:hover { opacity: 0.7; }


@keyframes letterExit {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    40% { transform: translateY(-40%) scale(1); opacity: 1; } /* Peek out of pocket */
    60% { transform: translateY(-40%) scale(1.05); opacity: 1; } /* Hover for a beat */
    100% { transform: translateY(-150vh) scale(1.2); opacity: 0; } /* Fly away to top */
}
    /* --- STABLE ANIMATIONS --- */
    @keyframes flap-bob {
        0%, 100% { transform: translateY(0); filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); }
        50% { transform: translateY(-8px); filter: drop-shadow(0 12px 8px rgba(0,0,0,0.2)); }
    }

    @keyframes seal-bob {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) translateY(-8px) scale(1); }
    }

    @keyframes nameReveal {
        0% { opacity: 0; transform: translate(-50%, 10px); }
        100% { opacity: 1; transform: translate(-50%, 0); }
    }

/* --- THE WRAPPER EXIT --- */
#envelope-wrapper {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    background-color: #f4f1ea;
    transition: opacity 1s ease, transform 1s ease; /* Controlled by handleMusic */
}

.prompt-btns { display: flex; gap: 15px; margin-top: 15px; justify-content: center; }
.prompt-btn { 
    border: 1px solid #043927; padding: 10px 25px; 
    cursor: pointer; font-family: 'Montserrat'; font-weight: bold; 
}
.prompt-btn.yes { background: #043927; color: white; }

   .envelope {
    position: relative; 
    width: 90vw; 
    height: 60vw;
    max-width: 600px; 
    max-height: 400px;
    z-index: 10; 
    /* This creates the 'room' for the flap to swing into */
    perspective: 1500px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

    .envelope-back {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: url('6938.jpg') center/cover no-repeat;
        z-index: 1; filter: brightness(0.9);
    }

    .envelope-pocket-main { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 3; background: url('6938.jpg') center/cover no-repeat;
        clip-path: polygon(0 0, 50% 50%, 100% 0, 100% 100%, 0 100%);
    }

    /* --- GUEST NAME (On Front) --- */
    #envelope-label {
    position: absolute;
    bottom: 12%; 
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    text-align: center;
    z-index: 20;
    font-family: 'Pinyon Script', cursive;
    /* clamp(min, preferred, max) - the magic of responsive text */
    font-size: clamp(1.2rem, 5vw, 2.2rem);
    color: #bfa17a;
    opacity: 0;
    pointer-events: none;
}

    .reveal-active {
        animation: nameReveal 0.8s ease-out forwards !important;
    }

    /* --- FLAP --- */
    .flap-container {
    position: absolute; 
    top: 0; left: 0; 
    width: 100%; height: 60%;
    z-index: 15; /* Sits above the pocket but behind the seal */
    
    /* THE HINGE: This locks the top edge so it can't move */
    transform-origin: top; 
    transform-style: preserve-3d;
    
    transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
    animation: flap-bob 4s ease-in-out infinite;
}

    .top-flap {
    width: 100%; height: 100%;
    background: url('6938.jpg') center/cover no-repeat;
    clip-path: polygon(0 0, 100% 0, 50% 100%);
    /* This makes sure the 'inside' of the flap is visible when it flips up */
    backface-visibility: visible;
}
    /* OPEN STATE: Clean and simple */
    .open .flap-container {
    animation: none !important;
    /* This swings the flap UP and BACK like a real hinge */
    transform: rotateX(160deg); 
    z-index: 2; /* Moves it behind the pocket once it's open */
}

    /* --- SEAL (Locked Size) --- */
    #seal {
    position: absolute; 
    top: 60%; 
    left: 50%;
    /* Instead of 100px, we use a % of the envelope's width */
    width: 18%; 
    min-width: 60px; /* Prevents it from disappearing on tiny phones */
    max-width: 110px; 
    z-index: 100; 
    cursor: pointer;
    animation: seal-bob 4s ease-in-out infinite;
    transition: opacity 0.4s ease;
}

    #seal img { width: 100%; height: auto; display: block; }
    .open #seal { opacity: 0; pointer-events: none; }

    /* --- DECORATIVE LINES --- */
    .envelope-lines {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 6; pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25'%3E%3Cline x1='0' y1='0' x2='50%25' y2='60%25' stroke='black' stroke-opacity='0.1' stroke-width='1'/%3E%3Cline x1='100%25' y1='0' x2='50%25' y2='60%25' stroke='black' stroke-opacity='0.1' stroke-width='1'/%3E%3C/svg%3E");
        background-size: 100% 100%;
    }

    #main-site { opacity: 0; display: none; transition: opacity 1.5s ease; }
    .show-site #main-site { opacity: 1; display: block; }
</style>
</head>
<body style="overflow: hidden;">

<div id="envelope-wrapper">
    <div class="envelope">
        <div class="envelope-back"></div>
        
        <div class="letter">
            <div class="letter-content">
                <h2 style="font-family: 'Great Vibes'; color: #043927; margin-bottom: 5px;">M & J</h2>
                <p style="font-family: 'Montserrat'; font-size: 0.8rem; letter-spacing: 1px;">Would you like to hear our wedding music?</p>
                <div class="prompt-btns">
                    <button class="prompt-btn yes" onclick="handleMusic(true)">YES</button>
                    <button class="prompt-btn" onclick="handleMusic(false)">NO</button>
                </div>
            </div>
        </div>

        <div class="flap-container">
            <div class="top-flap"></div>
        </div>
        <div class="envelope-pocket-main"></div>
        <div id="envelope-label"></div>
        
        <div id="seal" onclick="openInvitation()">
            <img src="seal.png" alt="Seal">
        </div>
    </div>
</div>
</div>


<div id="music-prompt" class="hidden">
    <p style="font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--accent);">
        Would you like to experience this with music?
    </p>
    <div class="prompt-btns">
        <button class="prompt-btn yes" onclick="handleMusic(true)">Yes, please</button>
        <button class="prompt-btn" onclick="handleMusic(false)">No, thanks</button>
    </div>
</div>

<audio id="bg-music" loop>
    <source src="bgm.pm3" type="audio/mpeg">
</audio>

<div id="main-site">
    <section style="height: 100vh; width: 100%; background: url('1.jpg') center/cover no-repeat; display: flex; align-items: center; justify-content: flex-end; position: relative; overflow: hidden;">
        <div style="position: absolute; top: 0; right: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(4, 57, 39, 0) 20%, rgba(4, 57, 39, 0.3) 50%, rgba(4, 57, 39, 0.8) 100%); z-index: 1;"></div>
        <div style="position: relative; padding-right: 10vw; text-align: right; z-index: 2;">
            <h1 style="font-family: 'Great Vibes', cursive; font-size: clamp(55px, 8vw, 110px); color: #d4af37; margin: 0; line-height: 1.1; text-shadow: 2px 2px 15px rgba(0,0,0,0.6);">
                Mariel <br> <span style="font-family: 'Georgia', serif; font-size: 0.3em; letter-spacing: 10px; color: #f4cfe0; vertical-align: middle;">&</span> <br> Jasper
            </h1>
            <div style="width: 80px; height: 1px; background: #d4af37; margin: 25px 0 25px auto;"></div>
            <p style="font-family: 'Georgia', serif; letter-spacing: 5px; font-size: clamp(14px, 1.5vw, 18px); text-transform: uppercase; color: #fff;">November 06, 2027</p>
            <p style="font-family: 'Georgia', serif; font-style: italic; color: #f4cfe0; font-size: 16px;">Save the Date</p>
            <div style="margin-top: 60px; font-size: 11px; letter-spacing: 4px; color: #d4af37; text-transform: uppercase;">Scroll to RSVP <span style="display:block; margin-top: 10px;">â†“</span></div>
        </div>
    </section>

    <section style="padding: 100px 20px; background-color: #fdf0f5; color: #043927; text-align: center;">
        <h2 style="font-family: 'Great Vibes', cursive; font-size: 45px; margin-bottom: 50px;">The Journey to Forever</h2>
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 60px; max-width: 1000px; margin: 0 auto;">
            <div style="flex: 1; min-width: 300px;"><img src="2.jpg" style="width: 100%; border: 1px solid #d4af37; padding: 10px; background: #fff; box-shadow: 15px 15px 0px #043927;"></div>
            <div style="flex: 1; min-width: 300px; margin-top: 80px;"><img src="3.jpg" style="width: 100%; border: 1px solid #d4af37; padding: 10px; background: #fff; box-shadow: -15px 15px 0px var(--pink);"></div>
        </div>
    </section>

    <section style="padding: 80px 20px; background-color: #fcfaf7; color: #043927; text-align: center;">
        <h2 style="font-family: 'Great Vibes', cursive; font-size: 45px; color: #d4af37; margin-bottom: 40px;">The Celebration</h2>
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 40px; max-width: 900px; margin: 0 auto;">
            <div style="flex: 1; min-width: 280px; padding: 30px; border: 1px solid #f4cfe0; background: white; box-shadow: 10px 10px 0px #043927;">
                <h3 style="font-family: 'Playfair Display'; text-transform: uppercase; font-size: 1.2rem;">The Ceremony</h3>
                <p style="color: #d4af37; font-weight: bold;">2:00 IN THE AFTERNOON</p>
                <p><strong>Santuario de San Antonio Parish</strong><br>Makati City</p>
            </div>
            <div style="flex: 1; min-width: 280px; padding: 30px; border: 1px solid #f4cfe0; background: white; box-shadow: 10px 10px 0px #f4cfe0;">
                <h3 style="font-family: 'Playfair Display'; text-transform: uppercase; font-size: 1.2rem;">The Reception</h3>
                <p style="color: #d4af37; font-weight: bold;">4:00 IN THE AFTERNOON</p>
                <p><strong>The Blue Leaf</strong><br>Taguig City</p>
            </div>
        </div>
    </section>

    <section style="padding: 100px 0; background-color: #043927; text-align: center;">
        <h2 style="font-family: 'Great Vibes', cursive; font-size: 40px; color: #d4af37; margin-bottom: 30px;">Our Story in Motion</h2>
        <div style="max-width: 800px; margin: 0 auto; padding: 0 20px;">
            <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border: 1px solid #d4af37;">
                <iframe src="https://www.youtube.com/embed/8RjcJXikhrk?rel=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </section>

    <section style="padding: 80px 20px; background: white; text-align: center;">
        <div style="max-width: 500px; margin: 0 auto;">
            <div id="loading" class="hidden">Checking invitation...</div>
            <div id="content" class="rsvp-card hidden"></div>
            <div id="error-msg" class="hidden rsvp-card"><p>Guest not found. Please use the original link.</p></div>
        </div>
    </section>
</div>

<script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbyUuEtZP-SXAsbamc-8oRGEf_qjsVYc2YFkbd8aakF7JA4WFxAVFLmhDBSAFFTI-p0Z/exec"; 
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('id');
    let guestData = null;

const music = document.getElementById('bg-music');

// Step 1: User clicks the seal
function openInvitation() {
    const wrapper = document.getElementById('envelope-wrapper');
    const seal = document.getElementById('seal');
    
    // 1. Open the flap and slide the letter UP with the question
    wrapper.classList.add('open');
    
    // 2. Hide the seal
    seal.style.opacity = "0";
    seal.style.pointerEvents = "none";

    // Start guest check in background
    if (token) checkGuestStatus();
}

function handleMusic(play) {
    const music = document.getElementById('bg-music');
    const wrapper = document.getElementById('envelope-wrapper');

    // 1. Play music if Yes
    if (play && music) {
        music.play().catch(e => console.log("Audio block:", e));
    }

    // 2. Fade out and slide up the WHOLE wrapper
    wrapper.style.opacity = "0";
    wrapper.style.transform = "translateY(-100vh)";

    // 3. Show the website
    setTimeout(() => {
        wrapper.style.display = "none";
        document.getElementById('main-site').style.display = 'block';
        
        setTimeout(() => {
            document.body.classList.add('show-site');
            document.body.style.overflow = 'auto'; // Re-enable scrolling
        }, 100);
    }, 1000);
}
    
    function checkGuestStatus() {
    // If there is no token, don't even try to fetch
    if (!token) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error-msg').classList.remove('hidden');
        return;
    }

    fetch(`${webAppUrl}?id=${encodeURIComponent(token)}`)
        .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        })
        .then(data => {
            guestData = data;
            document.getElementById('loading').classList.add('hidden');
            
            if (data && data.name) {
                // Trigger the Name Reveal on the Envelope
                const label = document.getElementById('envelope-label');
                label.innerText = `To our dear ${data.name}`;
                setTimeout(() => {
                    label.classList.add('reveal-active');
                }, 0);

                document.getElementById('loading').classList.add('hidden');

                // Load the RSVP form in the background
                data.isDone ? showDoneView(data) : showMainForm();

                
            } else {
                document.getElementById('error-msg').classList.remove('hidden');
            }
        })
        .catch(err => {
            console.error("Connection Error:", err);
            document.getElementById('loading').innerHTML = 
                `<p style="color:red;">Connection Error: Could not reach Google Sheets.</p>
                 <button onclick="checkGuestStatus()" style="padding:5px 10px; font-size:12px;">Retry</button>`;
        });
}

    function showMainForm() {
        const content = document.getElementById('content');
        content.classList.remove('hidden');
        const canP1 = String(guestData.allowPlusOne).toLowerCase() === "true";

        content.innerHTML = `
            <h2 style="font-family: 'Playfair Display';">Hi ${guestData.name},</h2>
            <label>Will you attend?</label>
            <select id="attending-select" onchange="togglePlusOne(${canP1})">
                <option value="Yes">Yes, I'll be there!</option>
                <option value="No">No, I can't make it</option>
            </select>
            <div id="p1-area"></div>
            <label>Email Address</label>
            <input type="email" id="guest-email" value="${guestData.email || ''}">
            <label>Message to the couple</label>
            <textarea id="guest-note">${guestData.note || ''}</textarea>
            <button class="btn" id="submit-btn" onclick="submitRSVP()">Confirm RSVP</button>`;
        togglePlusOne(canP1);
    }

    function togglePlusOne(canP1) {
        const area = document.getElementById('p1-area');
        const attending = document.getElementById('attending-select').value;
        if (attending === "Yes" && canP1) {
            area.innerHTML = `
                <label>Bringing a plus one?</label>
                <select id="bringing-p1" onchange="toggleP1Name()">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                </select>
                <div id="p1-name-wrapper"></div>`;
        } else { area.innerHTML = ''; }
    }

    function toggleP1Name() {
        const wrapper = document.getElementById('p1-name-wrapper');
        if (document.getElementById('bringing-p1').value === "Yes") {
            wrapper.innerHTML = '<label>Plus One Name</label><input type="text" id="plus-one-name" placeholder="Guest Name">';
        } else { wrapper.innerHTML = ''; }
    }

    function submitRSVP() {
        const btn = document.getElementById('submit-btn');
        btn.disabled = true; btn.innerHTML = "Saving...";
        const p1NameInput = document.getElementById('plus-one-name');
        const payload = {
            token: token,
            name: guestData.name,
            email: document.getElementById('guest-email').value,
            attending: document.getElementById('attending-select').value,
            plusOneName: p1NameInput ? p1NameInput.value : "None",
            note: document.getElementById('guest-note').value
        };
        fetch(webAppUrl, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(payload)
        }).then(() => {
            showDoneView({ ...guestData });
        });
    }

    function showDoneView(data) {
        const content = document.getElementById('content');
        content.classList.remove('hidden');
        content.innerHTML = `
            <div style="text-align: center;">
                <h2 style="font-family: 'Playfair Display';">Thank you!</h2>
                <p>RSVP recorded for ${data.name}.</p>
                <button class="btn" onclick="showMainForm()">Edit Response</button>
            </div>`;
    }
// This tells the browser to start looking for the guest name immediately
window.onload = checkGuestStatus;
</script>
</body>
</html>
